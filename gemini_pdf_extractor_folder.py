#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
gemini_pdf_extractor_folder.py
ä½¿ç”¨ Google Gemini 2.5 Pro æ¨¡å‹æ“·å– PDF ä¸­æ–‡å…§å®¹ï¼ˆå–®è¼ªåˆ†ç‰‡ + è‡ªå‹•é ç¢¼æ¨™è¨»ï¼‰ã€‚
æ¯æ‰¹ç¨ç«‹å‘¼å«æ¨¡å‹ï¼Œé¿å…å¤šè¼ªå°è©±éºæ¼æˆ–ç©ºç™½å•é¡Œã€‚
è‡ªå‹•åœ¨è¼¸å‡ºä¸­åŠ å…¥é ç¢¼æ®µè½æ¨™è¨»ã€‚
"""

import os
import sys
import math
import time
import textwrap
from dotenv import load_dotenv
from pypdf import PdfReader
import google.generativeai as genai
from google.generativeai.types import HarmCategory, HarmBlockThreshold

# === 1ï¸âƒ£ è¼‰å…¥ .env æª”æ¡ˆ ===
load_dotenv()

# === 2ï¸âƒ£ å¾ç’°å¢ƒè®Šæ•¸è®€å– API é‡‘é‘° ===
api_key = os.getenv("GOOGLE_API_KEY")

if not api_key:
    print("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° GOOGLE_API_KEYã€‚è«‹å»ºç«‹ .env æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹ï¼š")
    print("GOOGLE_API_KEY=ä½ çš„é‡‘é‘°")
    sys.exit(1)

# === 3ï¸âƒ£ è¨­å®š Gemini API ===
try:
    genai.configure(api_key=api_key)
    print("âœ… Google API é‡‘é‘°è¨­å®šæˆåŠŸï¼")
except Exception as e:
    print(f"âŒ è¨­å®š API é‡‘é‘°æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
    sys.exit(1)

# === 4ï¸âƒ£ è®€å–è¼¸å…¥åƒæ•¸ ===
if len(sys.argv) < 2:
    print("\nğŸ“˜ ä½¿ç”¨æ–¹å¼ï¼š")
    print("python gemini_pdf_extractor_folder.py <PDFç›®éŒ„è·¯å¾‘> [æ¯æ‰¹é æ•¸] [æ¯æ‰¹é–“éš”ç§’æ•¸]\n")
    print("ç¯„ä¾‹ï¼špython gemini_pdf_extractor_folder.py ./pdfs 30 10\n")
    sys.exit(0)

PDF_DIR = sys.argv[1]
CHUNK_SIZE = int(sys.argv[2]) if len(sys.argv) > 2 else 30  # é è¨­æ¯æ‰¹ 30 é 
WAIT_SECONDS = int(sys.argv[3]) if len(sys.argv) > 3 else 10  # é è¨­æ¯æ‰¹é–“éš” 10 ç§’

# === 5ï¸âƒ£ æª¢æŸ¥è¼¸å…¥ç›®éŒ„ ===
if not os.path.exists(PDF_DIR):
    print(f"âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›®éŒ„ã€Œ{PDF_DIR}ã€ã€‚")
    sys.exit(1)

pdf_files = [f for f in os.listdir(PDF_DIR) if f.lower().endswith(".pdf")]
if not pdf_files:
    print(f"âŒ ç›®éŒ„ {PDF_DIR} ä¸­æ²’æœ‰ PDF æª”æ¡ˆã€‚")
    sys.exit(1)

print(f"ğŸŸ¢ ç™¼ç¾ {len(pdf_files)} å€‹ PDF æª”æ¡ˆï¼Œé–‹å§‹è™•ç†...\n")


# === ä¸»è™•ç†å‡½å¼ ===
def process_large_pdf(pdf_path: str, output_file_path: str, chunk_size: int, wait_seconds: int):
    """å–®è¼ªåˆ†ç‰‡æ–¹å¼æ“·å– PDF å…§å®¹ï¼ˆæ¯æ‰¹ç¨ç«‹å‘¼å«æ¨¡å‹ï¼Œä¸¦è‡ªå‹•é ç¢¼æ¨™è¨»ï¼‰"""

    print(f"ğŸ” æ­£åœ¨è®€å– PDF: {pdf_path}...")
    try:
        reader = PdfReader(pdf_path)
        total_pages = len(reader.pages)
        print(f"ğŸ“„ æ–‡ä»¶ç¸½é æ•¸: {total_pages} é ")
    except Exception as e:
        print(f"âŒ ç„¡æ³•è®€å– PDFï¼š{e}")
        return

    if total_pages == 0:
        print("âŒ éŒ¯èª¤ï¼šæ­¤ PDF æ²’æœ‰é é¢ã€‚")
        return

    # === åˆå§‹åŒ–è¼¸å‡ºæª” ===
    with open(output_file_path, "w", encoding="utf-8") as f:
        f.write(f"å¾ PDF ã€Œ{os.path.basename(pdf_path)}ã€ æ“·å–çš„æ–‡å­—å…§å®¹\n")
        f.write("=" * 80 + "\n\n")

    # === ä¸Šå‚³æª”æ¡ˆè‡³ Gemini ===
    print("â˜ï¸ æ­£åœ¨ä¸Šå‚³æª”æ¡ˆè‡³ Google AI Studio...")
    uploaded_file = genai.upload_file(path=pdf_path, display_name=os.path.basename(pdf_path))
    print(f"âœ… ä¸Šå‚³æˆåŠŸï¼File URI: {uploaded_file.uri}")
    time.sleep(2)  # ç­‰å¾…å¾Œç«¯ç´¢å¼•å®Œæˆ

    # === åˆå§‹åŒ–æ¨¡å‹ ===
    model = genai.GenerativeModel(
        model_name="gemini-2.5-pro"
    )

    print("\nğŸš€ === é–‹å§‹åˆ†æ‰¹æ“·å– PDF å…§å®¹ï¼ˆå–®è¼ª + é ç¢¼æ¨™è¨»ï¼‰ ===")
    num_chunks = math.ceil(total_pages / chunk_size)

    for i in range(num_chunks):
        start_page = i * chunk_size + 1
        end_page = min((i + 1) * chunk_size, total_pages)
        progress = (i + 1) / num_chunks * 100

        print(f"\n[æ‰¹æ¬¡ {i + 1}/{num_chunks}] è™•ç†é ç¢¼: {start_page}â€“{end_page}")
        print(f"ğŸ“Š é€²åº¦: {progress:.1f}%")

        # === ğŸ§© è«‹è‡ªè¡Œè²¼ä¸Šå®Œæ•´ prompt ===
        prompt = textwrap.dedent(f"""
        æˆ‘ç¾åœ¨è¦è™•ç†é€™ä»½ PDF çš„ **ç¬¬ {start_page}â€“{end_page} é **ã€‚
        è«‹ä½ åš´æ ¼åƒ…è™•ç†é€™å€‹é ç¢¼ç¯„åœå…§çš„å…§å®¹ï¼Œçµ•å°ä¸è¦è·¨å‡ºæˆ–æå‰å¼•ç”¨å…¶ä»–é çš„è³‡è¨Šã€‚
        è«‹ä¾ç…§ä»¥ä¸‹æä¾›çš„ã€Šæ–‡æª”åˆ†æèˆ‡è½‰éŒ„è¦ç¯„ã€‹ï¼Œé€²è¡Œé«˜ä¿çœŸåº¦çš„å…§å®¹æ“·å–èˆ‡çµæ§‹åŒ–æ•´ç†ã€‚
        è¼¸å‡ºéœ€å®Œæ•´ä¿ç•™åŸå§‹è³‡è¨Šçš„èªæ„èˆ‡ä¸Šä¸‹æ–‡ï¼Œä¸¦æŒ‰ç…§**å°ç¯€åˆ†éš”**ï¼š
        - æ¯å€‹å°ç¯€æ‡‰å®Œæ•´å‘ˆç¾ä¸€å€‹ä¸»é¡Œæˆ–æ¦‚å¿µï¼Œæ–‡å­—ã€è¡¨æ ¼ã€å…¬å¼åŠåœ–è¡¨æ–‡å­—æè¿°åˆè¨ˆç´„ 1000â€“2000 å­—ï¼Œç›¡é‡ä¿æŒé‚è¼¯é€£è²«ã€‚  
        - æ¥è¿‘ä¸Šé™æ™‚è‡ªå‹•çµæŸå°ç¯€ä¸¦åŠ ä¸Šæ¨™è¨˜ï¼š
          `ï¼ˆç¬¬Xç« ç¯€çµæŸï¼‰`  
          X ç‚ºå°ç¯€ç·¨è™Ÿï¼Œè‡ªå‹•ç´¯åŠ ã€‚

        è«‹**ç›´æ¥è¼¸å‡ºçµæœï¼Œä¸éœ€å¤šé¤˜å›æ‡‰**ï¼Œä¸¦ç¢ºä¿ä¾ç…§åŸæ–‡èªè¨€å…§å®¹æ’°å¯«ï¼šä¸­æ–‡ä¿æŒä¸­æ–‡ï¼Œè‹±æ–‡æˆ–å…¶ä»–èªè¨€ä¿æŒåŸæ–‡ã€‚

        ---

        ## æ–‡æª”åˆ†æèˆ‡è½‰éŒ„è¦ç¯„

        #### è§’è‰² (Role)
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ–‡æª”åˆ†æå°ˆå®¶ï¼Œæ“…é•·å¾åŒ…å«æ–‡å­—ã€åœ–è¡¨å’Œè¤‡é›œæ’ç‰ˆçš„ PDF æ–‡ä»¶ä¸­ï¼Œé€²è¡Œé«˜ä¿çœŸåº¦çš„è³‡è¨Šæ“·å–èˆ‡çµæ§‹åŒ–æ•´ç†ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡æŒ‡å®šçš„ PDF é é¢å…§å®¹ï¼Œä¸€çµ²ä¸è‹Ÿåœ°è½‰æ›ç‚ºä¸€ä»½æ¸…æ™°ã€å®Œæ•´ã€ä¸”æ˜“æ–¼é–±è®€çš„æ–‡å­—ç¨¿ã€‚

        #### ä»»å‹™ç›®æ¨™ (Objective)
        ç²¾æº–åœ°è™•ç†ä½¿ç”¨è€…æä¾›çš„ PDF æª”æ¡ˆèˆ‡æŒ‡å®šçš„é ç¢¼ç¯„åœï¼Œå°‡æ‰€æœ‰å…§å®¹ï¼ˆæ–‡å­—ã€åœ–è¡¨ã€è¡¨æ ¼ç­‰ï¼‰è½‰æ›ç‚ºçµæ§‹åŒ–çš„æ–‡å­—æ ¼å¼ã€‚æ ¸å¿ƒç›®æ¨™æ˜¯**å®Œå…¨ä¿ç•™åŸå§‹è³‡è¨Šçš„å®Œæ•´æ€§èˆ‡ä¸Šä¸‹æ–‡é—œä¿‚**ã€‚

        ---

        #### æ ¸å¿ƒæŒ‡ä»¤ (Core Instructions)

        1. **é ç¢¼ç¯„åœ (Page Range):**
           - åš´æ ¼åƒ…è™•ç†ä½¿ç”¨è€…æŒ‡å®šçš„é ç¢¼ç¯„åœï¼ˆä¾‹å¦‚ï¼š`ç¬¬ 1â€“50 é `ï¼‰ã€‚å®Œå…¨å¿½ç•¥ç¯„åœå¤–çš„ä»»ä½•å…§å®¹ã€‚

        2. **å…§å®¹æ“·å–åŸå‰‡ (Extraction Principles):**
           - **ä¸»è¦æ–‡æœ¬å„ªå…ˆ:** ä»¥æ–‡ç« çš„ä¸»é«”å…§å®¹ç‚ºæ ¸å¿ƒï¼Œä¾åºæ“·å–ã€‚
           - **å¿½ç•¥éæ ¸å¿ƒå…ƒç´ :** é™¤éç‰¹åˆ¥æŒ‡ç¤ºï¼Œå¦å‰‡æ‡‰**å¿½ç•¥**é é¦–ã€é å°¾ã€é ç¢¼ã€ä»¥åŠä¸å½±éŸ¿æ–‡æ„ç†è§£çš„é‚Šç·£è£é£¾åœ–æ¡ˆã€‚
           - **æ®µè½å®šç¾©:** ä¸€å€‹ã€Œæ®µè½ã€æ˜¯æŒ‡ä¸€çµ„èªç¾©ä¸Šé€£çºŒçš„å¥å­ï¼Œé€šå¸¸ä»¥ç¸®æ’æˆ–æ›è¡Œåˆ†éš”ã€‚å³ä½¿åœ¨åŸå§‹æ–‡ä»¶ä¸­å› æ’ç‰ˆè€Œæ–·è¡Œï¼Œåªè¦èªç¾©é€£çºŒï¼Œå°±æ‡‰è¦–ç‚ºåŒä¸€æ®µè½ã€‚
           - **è·¨é æ®µè½è™•ç†:** è‹¥ä¸€å€‹æ®µè½å¾ç¬¬ X é çµå°¾é–‹å§‹ï¼Œä¸¦åœ¨ç¬¬ X+1 é é–‹é ­çµæŸï¼Œè«‹å°‡å…¶åˆä½µç‚ºå–®ä¸€æ®µè½ï¼Œä¸¦ä½¿ç”¨å…¶**èµ·å§‹é ç¢¼**é€²è¡Œæ¨™è¨˜ï¼Œå³ `ã€ç¬¬Xé , æ®µè½Yã€‘`ã€‚  
             åˆä½µå¾Œçš„æ®µè½ä¸å¾—çœç•¥æˆ–åˆªæ¸›ä»»ä½•å­—è©ï¼Œç¢ºä¿èªæ„é€£çºŒã€‚
           - **ç‰¹æ®Šæ ¼å¼æ–‡æœ¬:** ç¨‹å¼ç¢¼å€å¡Šã€æ•¸å­¸å…¬å¼æˆ–å¼•æ–‡ç­‰ç‰¹æ®Šæ ¼å¼ï¼Œè«‹ç›¡å¯èƒ½ä¿ç•™å…¶åŸå§‹æ’ç‰ˆï¼Œä¸¦ä½¿ç”¨ Markdown çš„ç¨‹å¼ç¢¼å€å¡Š (```) æˆ–å¼•ç”¨ (>) æ ¼å¼ä¾†å‘ˆç¾ã€‚  
             æ‰€æœ‰åŸå§‹èªè¨€ï¼ˆä¾‹å¦‚è‹±æ–‡è®Šæ•¸åç¨±æˆ–å…¬å¼ç¬¦è™Ÿï¼‰è«‹ä¿æŒä¸è®Šï¼Œä¸å¾—ç¿»è­¯æˆ–æ”¹å¯«ã€‚

        3. **è¦–è¦ºèˆ‡è¡¨æ ¼å…ƒç´ è™•ç† (Visual & Tabular Elements):**
           - **è­˜åˆ¥èˆ‡åˆ†é¡:** ç•¶é‡åˆ°ä»»ä½•éæ–‡å­—å…§å®¹æ™‚ï¼Œéœ€è­˜åˆ¥å…¶é¡å‹ï¼Œä¾‹å¦‚ï¼š`åœ–è¡¨` (Chart/Graph)ã€`ç¤ºæ„åœ–` (Diagram)ã€`ç…§ç‰‡` (Photo)ã€`æµç¨‹åœ–` (Flowchart)ã€`è¡¨æ ¼` (Table)ã€‚
           - **æ·±å…¥æè¿° (Description & Insight):**
             - å°æ–¼**åœ–è¡¨ã€ç¤ºæ„åœ–ã€æµç¨‹åœ–**ï¼Œä¸åƒ…è¦æè¿°å…¶å¤–è§€ï¼Œæ›´è¦æç…‰å…¶**æ ¸å¿ƒæ´è¦‹**ã€‚èªªæ˜è©²åœ–è¡¨è¦å‚³é”çš„ä¸»è¦è¨Šæ¯ã€æ•¸æ“šè¶¨å‹¢ã€çµ„ä»¶ä¹‹é–“çš„é—œä¿‚æˆ–æµç¨‹çš„æ­¥é©Ÿã€‚æè¿°æ‡‰ç‚º**å®Œæ•´ã€æœ‰æ„ç¾©çš„å¥å­**ã€‚
             - å°æ–¼**ç…§ç‰‡æˆ–æ’åœ–**ï¼Œæè¿°å…¶å…§å®¹ä»¥åŠå®ƒåœ¨ä¸Šä¸‹æ–‡ä¸­çš„ä½œç”¨ï¼ˆä¾‹å¦‚ï¼šå±•ç¤ºç”¢å“å¤–è§€ã€ç‡Ÿé€ ç‰¹å®šæ°›åœç­‰ï¼‰ã€‚
           - **è¡¨æ ¼è½‰éŒ„ (Table Transcription):**
             - å°‡è¡¨æ ¼å…§å®¹å®Œæ•´åœ°è½‰æ›ç‚º **Markdown è¡¨æ ¼æ ¼å¼**ã€‚ç¢ºä¿æ‰€æœ‰æ¬„ä½æ¨™é¡Œå’Œå„²å­˜æ ¼è³‡æ–™éƒ½è¢«æº–ç¢ºç„¡èª¤åœ°è½‰éŒ„ã€‚
             - è‹¥è¡¨æ ¼éæ–¼è¤‡é›œç„¡æ³•ç”¨ Markdown å‘ˆç¾ï¼Œå‰‡ä»¥æ¢åˆ—å¼æ¸…æ™°æè¿°å…¶çµæ§‹èˆ‡å…§å®¹ã€‚  
             æ‰€æœ‰å…ƒç´ ï¼ˆæ®µè½ã€è¦–è¦ºã€è¡¨æ ¼ï¼‰è«‹ä¾ç…§å®ƒå€‘åœ¨åŸå§‹æ–‡ä»¶ä¸­çš„å‡ºç¾é †åºæ’åˆ—è¼¸å‡ºï¼Œä¸å¾—é‡æ’ã€‚

        ---

        #### è¼¸å‡ºæ ¼å¼ (Output Format)

        * **æ®µè½ (Paragraph):**
          `ã€ç¬¬Xé , æ®µè½Yã€‘`
          [æ­¤è™•ç‚ºæ®µè½çš„å®Œæ•´æ–‡å­—å…§å®¹]

        * **è¦–è¦ºå…ƒç´  (Visual Element):**
          `ã€ç¬¬Xé , è¦–è¦ºå…ƒç´ Y: [é¡å‹]ã€‘`
          > [æ­¤è™•ç‚ºå°è©²è¦–è¦ºå…ƒç´ çš„æ·±å…¥æ–‡å­—æè¿°èˆ‡æ´è¦‹åˆ†æ]

        * **è¡¨æ ¼ (Table):**
          `ã€ç¬¬Xé , è¡¨æ ¼Yã€‘`
          [æ­¤è™•ç‚ºä½¿ç”¨ Markdown æ ¼å¼è½‰éŒ„çš„å®Œæ•´è¡¨æ ¼]

        * **å°ç¯€çµæŸæ¨™è¨˜:**
          åœ¨æ¯å€‹å°ç¯€ç´„ 1000â€“2000 å­—çµæŸæ™‚ï¼Œè«‹åŠ ä¸Šï¼š
          `ï¼ˆç¬¬Xç« ç¯€çµæŸï¼‰`  
          X ç‚ºå°ç¯€ç·¨è™Ÿï¼Œè‡ªå‹•ç´¯åŠ ã€‚

        * **ç·¨è™Ÿè¦å‰‡ (Numbering Rule):**
          æ‰€æœ‰å…ƒç´ ï¼ˆæ®µè½ã€è¦–è¦ºå…ƒç´ ã€è¡¨æ ¼ï¼‰çš„ç·¨è™Ÿ Y åœ¨æ¯ä¸€é éƒ½å¾ 1 é‡æ–°é–‹å§‹è¨ˆç®—ã€‚

        ---

        #### è¼¸å‡ºæ ¼å¼ç¯„ä¾‹ (Example)
        è«‹åƒ…è¼¸å‡ºä»¥ä¸‹æ ¼å¼çš„çµæœï¼Œä¸è¦åŠ å…¥ä»»ä½•é¡å¤–è§£é‡‹ã€è©•è«–æˆ–èªªæ˜æ–‡å­—ã€‚
        ````

        ã€ç¬¬10é , æ®µè½1ã€‘
        æœ¬ç« ç¯€æ—¨åœ¨ä»‹ç´¹ç¾ä»£é›»è·¯å­¸çš„åŸºæœ¬åŸç†ï¼Œä¸¦æ¢è¨èƒ½é‡å¦‚ä½•åœ¨å°é–‰è¿´è·¯ä¸­é€²è¡Œå‚³å°ã€‚æˆ‘å€‘å°‡å¾æœ€åŸºç¤çš„å…ƒä»¶é–‹å§‹ã€‚

        ã€ç¬¬10é , è¦–è¦ºå…ƒç´ 1: ç¤ºæ„åœ–ã€‘

        > ä¸€å¼µé›»è·¯ç¤ºæ„åœ–ï¼Œå±•ç¤ºä¸€é¡†é›»æ± ï¼ˆæ¨™ç¤ºæ­£è² æ¥µï¼‰é€éå°ç·šé€£æ¥ä¸€å€‹é›»é˜»å™¨ï¼Œå½¢æˆä¸€å€‹é–‰åˆè¿´è·¯ã€‚åœ–ä¸­ç”¨ç®­é ­æ¸…æ™°æ¨™ç¤ºäº†å‚³çµ±é›»æµï¼ˆIï¼‰å¾æ­£æ¥µæµå‘è² æ¥µçš„æ–¹å‘ï¼ŒåŒæ™‚ä¹Ÿæš—ç¤ºäº†é›»å­æµçš„ç›¸åè·¯å¾‘ã€‚æ­¤åœ–æ—¨åœ¨èªªæ˜æ§‹æˆåŸºæœ¬é›»è·¯çš„ä¸‰å€‹è¦ç´ ï¼šé›»æºã€å°ç·šèˆ‡è² è¼‰ã€‚

        ã€ç¬¬11é , æ®µè½1ã€‘
        æ ¹æ“šå¾·åœ‹ç‰©ç†å­¸å®¶æ ¼å¥§çˆ¾æ ¼Â·æ­å§†æå‡ºçš„æ­å§†å®šå¾‹ï¼Œé›»è·¯ä¸­çš„é›»å£“ã€é›»æµèˆ‡é›»é˜»ä¹‹é–“å­˜åœ¨ç·šæ€§é—œä¿‚ï¼Œæ•¸å­¸è¡¨é”å¼ç‚º V = IRã€‚

        ã€ç¬¬11é , è¡¨æ ¼1ã€‘

        | å¯¦é©—åºè™Ÿ | é›»å£“ (V) | é›»æµ (A) | é›»é˜» (Î©) |
        | :--- | :----- | :----- | :----- |
        | 1    | 5.0    | 0.5    | 10.0   |
        | 2    | 10.0   | 1.0    | 10.0   |
        | 3    | 12.0   | 0.6    | 20.0   |

        ã€ç¬¬12é , æ®µè½1ã€‘
        åŸºæ–¼ä¸Šè¿°å®šå¾‹ï¼Œæˆ‘å€‘å¯ä»¥é€²ä¸€æ­¥åˆ†ææ›´è¤‡é›œçš„é›»è·¯çµæ§‹ï¼Œä¾‹å¦‚ä¸²è¯é›»è·¯èˆ‡ä¸¦è¯é›»è·¯ã€‚é€™å…©ç¨®é€£æ¥æ–¹å¼åœ¨ç¾å¯¦ä¸–ç•Œçš„é›»å­è¨­å‚™ä¸­æœ‰è‘—å»£æ³›çš„æ‡‰ç”¨ã€‚

        ï¼ˆç¬¬1ç« ç¯€çµæŸï¼‰

        ```
        """)



        # === å‘¼å« Gemini ===
        try:
            response = model.generate_content(
                [prompt, uploaded_file],
                safety_settings=None
            )
            # === æª¢æŸ¥å›æ‡‰ ===
            if not hasattr(response, "text") or not response.text.strip():
                print(f"âš ï¸ ç„¡å›æ‡‰å…§å®¹æˆ–æ¨¡å‹æœªè¿”å›æ–‡å­—ï¼ˆç¬¬ {i + 1} æ‰¹ï¼‰ã€‚")
                continue

            batch_header = f"\n\n===== {os.path.basename(pdf_path)} | ç¬¬ {start_page}â€“{end_page} é  =====\n\n"
            batch_footer = "\n" + "=" * 80 + "\n"

            # === å¯«å…¥è¼¸å‡ºæª”æ¡ˆ ===
            with open(output_file_path, "a", encoding="utf-8") as f:
                f.write(batch_header)
                f.write(response.text.strip())
                f.write(batch_footer)
                f.flush()
                os.fsync(f.fileno())

            print(f"âœ… å·²å¯«å…¥ {output_file_path} ï¼ˆç¬¬ {start_page}â€“{end_page} é ï¼‰")
            print(f"ğŸ“¦ æª”æ¡ˆç›®å‰å¤§å°ï¼š{os.path.getsize(output_file_path)/1024:.1f} KB")

        except Exception as e:
            error_msg = f"âŒ ç¬¬ {i + 1} æ‰¹éŒ¯èª¤ï¼ˆé ç¢¼ {start_page}â€“{end_page}ï¼‰ï¼š{e}\n"
            print(error_msg)
            with open(output_file_path, "a", encoding="utf-8") as f:
                f.write(error_msg)
                
        # === é–“éš”ç­‰å¾… ===
        if i < num_chunks - 1:
            print(f"â³ ç­‰å¾… {wait_seconds} ç§’å¾Œé€²è¡Œä¸‹ä¸€æ‰¹...")
            time.sleep(wait_seconds)

    print("\nğŸ === æ‰€æœ‰é é¢è™•ç†å®Œç•¢ï¼ ===")
    time.sleep(2)


# === åŸ·è¡Œå…¥å£ ===
if __name__ == "__main__":
    for pdf_file in pdf_files:
        pdf_path = os.path.join(PDF_DIR, pdf_file)
        base_name = os.path.splitext(pdf_file)[0]

        # è¼¸å‡ºæª”èˆ‡åŸ PDF åŒç›®éŒ„
        txt_output_file = os.path.join(PDF_DIR, f"{base_name}_extracted.txt")

        if os.path.exists(txt_output_file):
            print(f"â„¹ï¸ å·²å­˜åœ¨ {txt_output_file}ï¼Œè·³éæ­¤æª”æ¡ˆã€‚")
            continue

        print(f"\nğŸ”¹ é–‹å§‹è™•ç† PDFï¼š{pdf_file}")
        process_large_pdf(pdf_path, txt_output_file, CHUNK_SIZE, WAIT_SECONDS)
        print(f"ğŸ‰ å·²å®Œæˆ PDFï¼š{pdf_file}ï¼Œè¼¸å‡ºè‡³ {txt_output_file}")


